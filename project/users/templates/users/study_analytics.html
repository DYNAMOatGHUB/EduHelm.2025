{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Analytics | EduHelm</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #f7f9fc;
            --card-bg: #ffffff;
            --text-color: #1a1a1a;
            --subtle-text: #606060;
            --primary-color: #4CAF50;
            --accent-color: #007bff;
            --border-color: #e0e0e0;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', 'Segoe UI', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-color); min-height: 100vh; padding: 30px; }
        
        .container { max-width: 1400px; margin: 0 auto; }
        
        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--accent-color);
            text-decoration: none;
            margin-bottom: 20px;
            font-weight: 500;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--subtle-text);
            font-size: 0.95em;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .chart-card h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .insights-section {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .insights-section h2 {
            margin-bottom: 20px;
        }
        
        .insight-item {
            padding: 20px;
            background: var(--bg-color);
            border-left: 4px solid var(--primary-color);
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .insight-title {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .insight-text {
            color: var(--subtle-text);
        }
        
        .time-breakdown {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .time-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .time-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .time-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .time-label {
            color: var(--subtle-text);
            font-size: 0.9em;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        @media (max-width: 968px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .time-breakdown {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="{% url 'study_dashboard' %}" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        
        <div class="header">
            <h1><i class="fas fa-chart-line"></i> Study Analytics</h1>
            <p style="color: var(--subtle-text);">Insights into your learning journey</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="color: var(--primary-color);">
                    <i class="fas fa-book-open"></i>
                </div>
                <div class="stat-value">{{ total_sessions }}</div>
                <div class="stat-label">Total Sessions</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="color: var(--accent-color);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-value">{{ total_hours|floatformat:1 }}</div>
                <div class="stat-label">Total Hours</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="color: #f39c12;">
                    <i class="fas fa-stopwatch"></i>
                </div>
                <div class="stat-value">{{ avg_session_minutes|floatformat:0 }}</div>
                <div class="stat-label">Avg Session (min)</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="color: #ff6b6b;">
                    <i class="fas fa-fire"></i>
                </div>
                <div class="stat-value">{{ profile.study_streak }}</div>
                <div class="stat-label">Current Streak</div>
            </div>
        </div>
        
        <div class="time-breakdown">
            <div class="time-card">
                <div class="time-icon" style="color: #ffd93d;">
                    <i class="fas fa-sun"></i>
                </div>
                <div class="time-value">{{ morning_minutes }}</div>
                <div class="time-label">Morning Minutes</div>
                <small style="color: var(--subtle-text);">6 AM - 12 PM</small>
            </div>
            
            <div class="time-card">
                <div class="time-icon" style="color: #ff9800;">
                    <i class="fas fa-cloud-sun"></i>
                </div>
                <div class="time-value">{{ afternoon_minutes }}</div>
                <div class="time-label">Afternoon Minutes</div>
                <small style="color: var(--subtle-text);">12 PM - 6 PM</small>
            </div>
            
            <div class="time-card">
                <div class="time-icon" style="color: #3f51b5;">
                    <i class="fas fa-moon"></i>
                </div>
                <div class="time-value">{{ evening_minutes }}</div>
                <div class="time-label">Evening Minutes</div>
                <small style="color: var(--subtle-text);">6 PM - 12 AM</small>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-card full-width">
                <h2><i class="fas fa-chart-area"></i> Last 30 Days Activity</h2>
                <div class="chart-container">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2><i class="fas fa-chart-pie"></i> Top Courses</h2>
                <div class="chart-container">
                    <canvas id="courseChart"></canvas>
                </div>
            </div>
            
            <div class="chart-card">
                <h2><i class="fas fa-chart-bar"></i> Time of Day</h2>
                <div class="chart-container">
                    <canvas id="timeChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="insights-section">
            <h2><i class="fas fa-lightbulb"></i> Insights & Recommendations</h2>
            
            <div class="insight-item">
                <div class="insight-title">
                    <i class="fas fa-trophy" style="color: #f39c12;"></i>
                    Study Streak
                </div>
                <div class="insight-text">
                    {% if profile.study_streak >= 7 %}
                        Excellent! You've maintained a {{ profile.study_streak }}-day streak. Keep up the great work!
                    {% elif profile.study_streak >= 3 %}
                        Good job! You're on a {{ profile.study_streak }}-day streak. Try to reach a week!
                    {% else %}
                        Study consistently to build your streak and form a learning habit.
                    {% endif %}
                </div>
            </div>
            
            <div class="insight-item">
                <div class="insight-title">
                    <i class="fas fa-clock" style="color: var(--primary-color);"></i>
                    Best Study Time
                </div>
                <div class="insight-text">
                    {% if morning_minutes > afternoon_minutes and morning_minutes > evening_minutes %}
                        You're most productive in the morning ({{ morning_minutes }} minutes). Schedule important topics during this time.
                    {% elif afternoon_minutes > morning_minutes and afternoon_minutes > evening_minutes %}
                        You study most in the afternoon ({{ afternoon_minutes }} minutes). This is your peak learning time.
                    {% else %}
                        You prefer evening study sessions ({{ evening_minutes }} minutes). Make sure to get adequate rest.
                    {% endif %}
                </div>
            </div>
            
            <div class="insight-item">
                <div class="insight-title">
                    <i class="fas fa-chart-line" style="color: var(--accent-color);"></i>
                    Performance
                </div>
                <div class="insight-text">
                    {% if avg_session_minutes >= 45 %}
                        Great focus! Your average session is {{ avg_session_minutes|floatformat:0 }} minutes - perfect for deep learning.
                    {% elif avg_session_minutes >= 25 %}
                        Your average session is {{ avg_session_minutes|floatformat:0 }} minutes. Consider extending to 45+ minutes for better retention.
                    {% else %}
                        Your sessions average {{ avg_session_minutes|floatformat:0 }} minutes. Try the Pomodoro technique (25-min focus + 5-min break).
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Daily Activity Chart
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        const dailyData = {{ daily_data|safe }};
        
        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: dailyData.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }),
                datasets: [{
                    label: 'Study Minutes',
                    data: dailyData.map(d => d.minutes),
                    borderColor: '#4CAF50',
                    backgroundColor: 'rgba(76, 175, 80, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' min';
                            }
                        }
                    }
                }
            }
        });
        
        // Course Breakdown Chart
        const courseCtx = document.getElementById('courseChart').getContext('2d');
        const courseBreakdown = {{ course_breakdown|safe }};
        
        new Chart(courseCtx, {
            type: 'doughnut',
            data: {
                labels: courseBreakdown.map(c => c.course__title || 'General Study'),
                datasets: [{
                    data: courseBreakdown.map(c => c.total_minutes),
                    backgroundColor: [
                        '#4CAF50',
                        '#007bff',
                        '#f39c12',
                        '#e74c3c',
                        '#9b59b6'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
        
        // Time of Day Chart
        const timeCtx = document.getElementById('timeChart').getContext('2d');
        
        new Chart(timeCtx, {
            type: 'bar',
            data: {
                labels: ['Morning', 'Afternoon', 'Evening'],
                datasets: [{
                    label: 'Minutes',
                    data: [{{ morning_minutes }}, {{ afternoon_minutes }}, {{ evening_minutes }}],
                    backgroundColor: [
                        '#ffd93d',
                        '#ff9800',
                        '#3f51b5'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + ' min';
                            }
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>
